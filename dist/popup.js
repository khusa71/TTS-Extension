(()=>{"use strict";document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("apiKey"),t=document.getElementById("saveApiKey"),n=document.getElementById("apiKeyStatus"),o=document.getElementById("voiceSelect"),s=document.getElementById("voiceInfo"),a=document.getElementById("speedRange"),c=document.getElementById("speedValue"),i=document.querySelectorAll(".speed-preset"),l=document.getElementById("readSelected"),r=document.getElementById("readPage"),d=document.getElementById("pause"),u=document.getElementById("resume"),g=document.getElementById("stop"),m=document.getElementById("next"),p=document.getElementById("previous"),y=document.getElementById("enableHighlight"),h=document.getElementsByName("highlightType");function v(e){if(!e)return console.error("API key is missing"),n.textContent="Error: API key is missing. Please set it below.",n.style.color="red",void(o.innerHTML='<option value="">No API key - voices unavailable</option>');if(!/^[A-Za-z0-9_-]{20,}$/.test(e))return console.error("API key appears to be invalid (format check failed)"),n.textContent="Error: API key appears to be invalid (wrong format).",n.style.color="red",void(o.innerHTML='<option value="">Invalid API key format</option>');n.textContent="Validating API key...",n.style.color="blue";const t=document.createElement("option");t.textContent="Loading voices...",o.innerHTML="",o.appendChild(t);const a=o.parentElement;let c=a?.querySelector(".voice-loading-spinner");!c&&a?(c=document.createElement("div"),c.className="voice-loading-spinner",c.style.display="inline-block",c.style.width="20px",c.style.height="20px",c.style.border="3px solid rgba(0, 0, 0, 0.1)",c.style.borderRadius="50%",c.style.borderTopColor="#3498db",c.style.animation="spin 1s ease-in-out infinite",c.style.marginLeft="10px",a.appendChild(c)):c&&(c.style.display="inline-block");const i="https://texttospeech.googleapis.com/v1/voices?key="+e;console.log("Sending fetch request to Google Cloud TTS API voices endpoint"),fetch(i).then((e=>{if(console.log("Response received:",e.status,e.statusText),!e.ok)throw 400===e.status?new Error("API key format is invalid. Please check for typos or generate a new key."):403===e.status?new Error("API key is invalid or Text-to-Speech API is not enabled in your Google Cloud Console."):404===e.status?new Error("API endpoint not found. Check if the Text-to-Speech API is enabled."):429===e.status?new Error("API rate limit exceeded. Please try again later."):new Error(`Error fetching voices: ${e.status} ${e.statusText}`);return e.json()})).then((e=>{if(!e.voices||!Array.isArray(e.voices)||0===e.voices.length)throw new Error("No voices returned from the API. Verify your API key permissions.");const t=e.voices;console.log(`Successfully fetched ${t.length} voices from Google Cloud TTS API`),n.textContent="API key valid ✓",n.style.color="green",o.innerHTML="",t.sort(((e,t)=>{const n=e.languageCodes[0],o=t.languageCodes[0];return n.localeCompare(o)}));const a=new Map;t.forEach((e=>{const t=e.languageCodes[0];a.has(t)||a.set(t,[]),a.get(t).push(e)}));const c=new Intl.DisplayNames(["en"],{type:"language"});a.forEach(((e,t)=>{const n=document.createElement("optgroup");try{const o=c.of(t.split("-")[0])||t;n.label=`${o} (${t}) - ${e.length} voices`}catch(o){n.label=`${t} (${e.length} voices)`}e.sort(((e,t)=>{const n=f(e.name),o={Neural2:4,Studio:3,Wavenet:2,Standard:1},s=(o[f(t.name)]||0)-(o[n]||0);return 0!==s?s:e.ssmlGender.localeCompare(t.ssmlGender)})),e.forEach((e=>{const t=document.createElement("option");t.value=e.name;const o=f(e.name),s="Standard"!==o;t.textContent=`${e.name} (${o}${s?" $":""}, ${e.ssmlGender})`,t.dataset.language=e.languageCodes[0],t.dataset.gender=e.ssmlGender||"unknown",t.dataset.type=o,n.appendChild(t)})),o.appendChild(n)})),chrome.storage.local.get(["selectedVoice"],(e=>{if(e.selectedVoice)for(let t=0;t<o.options.length;t++)if(o.options[t].value===e.selectedVoice){o.selectedIndex=t;break}-1===o.selectedIndex&&o.options.length>0&&(o.selectedIndex=0);const t=o.options[o.selectedIndex];t&&function(e,t){if(!t)return;const n={Neural2:'<span class="badge neural">Neural2</span>',WaveNet:'<span class="badge wavenet">WaveNet</span>',Standard:'<span class="badge standard">Standard</span>'}[e.type]||"";t.innerHTML=`\n        <div class="voice-detail">\n            <span class="voice-language">${e.language}</span>\n            <span class="voice-gender">${e.gender}</span>\n            ${n}\n        </div>\n    `}({name:t.value,language:t.dataset.language||"",gender:t.dataset.gender||"",type:t.dataset.type||""},s)})),function(){let e=document.getElementById("voiceSearch");e||(e=document.createElement("input"),e.id="voiceSearch",e.type="text",e.placeholder="Search voices by name or language...",e.style.width="100%",e.style.marginBottom="10px",e.style.padding="5px",e.style.boxSizing="border-box",o.parentNode?.insertBefore(e,o),e.addEventListener("input",E))}()})).catch((e=>{console.error("Error fetching voices from Google Cloud TTS API:",e),n.textContent=`Error: ${e.message}`,n.style.color="red",o.innerHTML='<option value="">Failed to load voices</option>';const t=document.getElementById("diagnosticLinkContainer");t&&(t.style.display="block")})).finally((()=>{c&&(c.style.display="none")}))}function f(e){return e.includes("Neural2")?"Neural2":e.includes("Studio")?"Studio":e.includes("Wavenet")?"Wavenet":"Standard"}function E(e){const t=e.target.value.toLowerCase(),n=o.querySelectorAll("optgroup");let s=0;n.forEach((e=>{const n=e.querySelectorAll("option");let o=0;n.forEach((e=>{const n=e.textContent?.toLowerCase()||"",s=e.dataset.language?.toLowerCase()||"",a=n.includes(t)||s.includes(t);e.style.display=a?"":"none",a&&o++})),e.style.display=o>0?"":"none",o>0&&s++}));let a=document.getElementById("noVoiceMatches");0===s?a?a.style.display="":(a=document.createElement("div"),a.id="noVoiceMatches",a.textContent="No voices match your search",a.style.color="red",a.style.marginTop="5px",o.parentNode?.insertBefore(a,o.nextSibling)):a&&(a.style.display="none")}document.getElementById("progress-container"),document.getElementById("progress-fill"),document.getElementById("currentTime"),document.getElementById("totalTime"),function(e){const{onboardingModal:t,closeOnboarding:n,themeToggle:o,apiKeyStatus:s,speedRange:a,speedValue:c,speedPresets:i,enableHighlight:l,highlightOptions:r,showOnboardingCallback:d,hideOnboardingCallback:u,updateSpeedPresets:g,updateSettings:m,showStatusCallback:p}=e;function y(){t.style.display="flex",n.focus()}function h(){t.style.display="none"}var v;n&&n.addEventListener("click",h),window.addEventListener("keydown",(e=>{"flex"!==t.style.display||"Escape"!==e.key&&"Enter"!==e.key||h()})),localStorage.getItem("tts_onboarded")||(setTimeout(y,400),localStorage.setItem("tts_onboarded","1")),d&&d(y),u&&u(h),v="1"===localStorage.getItem("tts_theme_dark"),document.body.classList.toggle("dark-mode",v),o&&(o.innerHTML=v?'<i class="fas fa-sun"></i>':'<i class="fas fa-moon"></i>'),o&&o.addEventListener("click",(()=>{const e=document.body.classList.toggle("dark-mode");!function(e){localStorage.setItem("tts_theme_dark",e?"1":"0")}(e),o.innerHTML=e?'<i class="fas fa-sun"></i>':'<i class="fas fa-moon"></i>'})),document.querySelectorAll(".help-icon").forEach((e=>{const t=e.getAttribute("title");t&&(e.setAttribute("aria-label",t),e.setAttribute("role","tooltip"))}))}({onboardingModal:document.getElementById("onboardingModal"),closeOnboarding:document.getElementById("closeOnboarding"),themeToggle:document.getElementById("themeToggle"),apiKeyStatus:n,speedRange:a,speedValue:c,speedPresets:i,enableHighlight:y,highlightOptions:h,showOnboardingCallback:e=>{},hideOnboardingCallback:e=>{},updateSpeedPresets:e=>{i.forEach((t=>{const n=parseFloat(t.dataset.speed||"1");t.classList.toggle("active",n===parseFloat(e.toString()))}))},updateSettings:e=>{},showStatusCallback:(e,t)=>{}}),chrome.storage.local.get(["googleApiKey"],(e=>{v(e.googleApiKey||"")}));const I=document.querySelector(".voice-section");if(I){const e=document.createElement("div");e.className="auto-detect-language",e.innerHTML='\n            <button id="autoDetectLanguage" class="secondary-button auto-detect-btn">\n                <i class="fas fa-magic"></i> Auto-detect language\n            </button>\n            <div class="detected-language-info" id="detectedLanguageInfo" style="display: none;"></div>\n        ';const t=document.getElementById("voiceInfo");t?t.parentNode?.insertBefore(e,t):I.appendChild(e);const n=document.getElementById("autoDetectLanguage");n&&n.addEventListener("click",(()=>{chrome.tabs.query({active:!0,currentWindow:!0},(e=>{e[0]?.id&&chrome.scripting.executeScript({target:{tabId:e[0].id},func:()=>{const e=window.getSelection();return e?.toString()||""}},(e=>{if(e&&e[0]?.result){const t=e[0].result;if(t){const e=document.getElementById("speedRange"),n=e?parseFloat(e.value):1,o=document.getElementById("voiceSelect"),s=Array.from(o.options).map((e=>({name:e.value,languageCode:e.dataset.language||"",gender:e.dataset.gender||"",type:e.dataset.type||""})));chrome.runtime.sendMessage({action:"setAvailableVoices",voices:s},(()=>{chrome.runtime.sendMessage({action:"autoDetectLanguage",text:t,speed:n})}));const a=document.getElementById("detectedLanguageInfo");a&&(a.textContent="Detecting language...",a.style.display="block")}else alert("Please select some text on the page first")}else alert("Could not access page text. Please make sure you have selected text in the page.")}))}))}))}chrome.runtime.onMessage.addListener((e=>{if("ttsInfo"===e.action&&e.info?.includes("Detected language")){const t=document.getElementById("detectedLanguageInfo");t&&(t.textContent=e.info,t.style.display="block",t.className="detected-language-info success")}return!0}));const b=document.getElementById("voiceGenderPreference"),C=document.getElementById("voiceTypePreference");if(b&&C){chrome.storage.local.get(["voicePreferences"],(e=>{const t=e.voicePreferences||{};t.gender&&(b.value=t.gender),t.voiceType&&(C.value=t.voiceType)}));const e=()=>{const e={gender:b.value||void 0,voiceType:C.value||void 0};chrome.storage.local.set({voicePreferences:e},(()=>{console.log("Voice preferences saved:",e);const t=document.createElement("div");t.className="save-confirmation",t.textContent="Preferences saved";const n=b.closest(".voice-pref-section");n&&(n.appendChild(t),setTimeout((()=>{t.remove()}),2e3))}))};b.addEventListener("change",e),C.addEventListener("change",e)}function x(){chrome.storage.local.get(["ttsCacheStats"],(e=>{if(e.ttsCacheStats){const t=e.ttsCacheStats,n=document.getElementById("cacheHits"),o=document.getElementById("cacheMisses"),s=document.getElementById("cacheSize");n&&(n.textContent=`Hits: ${t.hits}`),o&&(o.textContent=`Misses: ${t.misses}`),s&&(s.textContent=`Items: ${t.size}`)}}))}x();const k=document.getElementById("clearCache");k&&k.addEventListener("click",(()=>{chrome.runtime.sendMessage({action:"clearCache"},(()=>{x();const e=document.querySelector(".cache-stats");if(e){const t=document.createElement("div");t.className="success-message",t.textContent="Cache cleared successfully",e.appendChild(t),setTimeout((()=>t.remove()),3e3)}}))})),chrome.runtime.onMessage.addListener((e=>("cacheStatsUpdated"===e.action&&x(),!0))),t.addEventListener("click",(()=>{const t=e.value.trim();t?chrome.storage.local.set({googleApiKey:t},(()=>{chrome.runtime.sendMessage({action:"apiKeyUpdated",newKey:t}),n.textContent="API Key saved successfully!",n.className="success-message",setTimeout((()=>{n.textContent=""}),3e3),v(t)})):(n.textContent="Please enter a valid API key.",n.className="error-message")}));const S=document.getElementById("openDiagnostics");S&&S.addEventListener("click",(e=>{e.preventDefault(),chrome.runtime.openOptionsPage()})),l.addEventListener("click",(()=>{chrome.tabs.query({active:!0,currentWindow:!0},(e=>{e[0]?.id&&chrome.scripting.executeScript({target:{tabId:e[0].id},func:()=>window.getSelection()?.toString()||""},(e=>{if(e&&e[0]?.result){const t=e[0].result;t?chrome.runtime.sendMessage({action:"readText",text:t,voice:o.value,speed:Number(a.value)}):(n.textContent="No text selected.",n.className="error-message")}}))}))})),r.addEventListener("click",(()=>{chrome.tabs.query({active:!0,currentWindow:!0},(e=>{e[0]?.id&&chrome.scripting.executeScript({target:{tabId:e[0].id},func:()=>document.body.innerText},(e=>{if(e&&e[0]?.result){const t=e[0].result;t&&chrome.runtime.sendMessage({action:"readText",text:t,voice:o.value,speed:Number(a.value)})}}))}))})),d.addEventListener("click",(()=>{chrome.runtime.sendMessage({action:"pauseReading"})})),u.addEventListener("click",(()=>{chrome.runtime.sendMessage({action:"resumeReading"})})),g.addEventListener("click",(()=>{chrome.runtime.sendMessage({action:"stopReading"})})),m.addEventListener("click",(()=>{chrome.runtime.sendMessage({action:"nextChunk"})})),p.addEventListener("click",(()=>{chrome.runtime.sendMessage({action:"previousChunk"})})),chrome.runtime.onMessage.addListener((e=>("apiKeyValid"===e.action?n&&(n.textContent="API key is valid ✓",n.style.color="green"):"apiKeyInvalid"===e.action?n&&(n.textContent=e.error||"API key is invalid",n.style.color="red"):"ttsError"===e.action&&n&&(n.textContent=e.error||"TTS Error occurred",n.style.color="red"),!0)))}))})();