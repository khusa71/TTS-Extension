(()=>{"use strict";const e={enableCaching:!0,maxCacheSize:20,audioChunkTimeout:1e4,maxRetries:3,retryDelay:1e3,useRequestBatching:!0,batchWindow:100,logPerformanceMetrics:!1};let t,s,o,a=e,r=null,i="",c=[],n=!1,l=0,h=0,d={speed:1,highlightType:"word",enableHighlight:!0};var u;async function g(e,t,s){if(console.log("Starting synthesis and playback with:",{text:e,voice:t,speed:s}),!e||!t||!i)return console.error("Missing required parameters for synthesis:",{text:e,voice:t,userApiKey:i}),void chrome.runtime.sendMessage({action:"ttsError",error:i?"Missing text or voice selection":"No API key provided"});try{const o=await async function(e,t,s){console.log("Sending request to Google TTS API with:",{text:e,voice:t,speed:s});const o="https://texttospeech.googleapis.com/v1/text:synthesize?key="+i,a={input:{text:e},voice:{languageCode:t.split("-")[0],name:t},audioConfig:{audioEncoding:"MP3",speakingRate:s}};try{const e=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!e.ok){const t=await e.json();throw console.error("Google TTS API error:",t),new Error(`Google TTS API error: ${t.error?.message||e.statusText}`)}const t=await e.json();return console.log("Google TTS API response received:",t),t}catch(e){throw console.error("Error during Google TTS API request:",e),e}}(e,t,s);if(!o.audioContent)return void console.error("No audio content received from Google TTS API.");const a=new Audio(`data:audio/mp3;base64,${o.audioContent}`);console.log("Playing audio..."),a.play().catch((e=>{console.error("Error during audio playback:",e)}))}catch(e){console.error("Error during synthesis and playback:",e)}}function p(){if(!n||l>=c.length)return n=!1,void chrome.runtime.sendMessage({action:"playbackComplete"});const e=c[l];r=e.audio,r.playbackRate=d.speed,r.onended=()=>{l++,p()},r.ontimeupdate=()=>{if(r&&(h=e.startTime+r.currentTime,chrome.runtime.sendMessage({action:"playbackProgress",currentTime:h,totalDuration:0,currentChunk:l,totalChunks:c.length}),d.enableHighlight)){const t=r.currentTime/r.duration,s=e.text;if("word"===d.highlightType){const e=s.split(/\s+/),o=e[Math.floor(t*e.length)];o&&chrome.tabs.query({active:!0,currentWindow:!0},(e=>{e[0]?.id&&chrome.tabs.sendMessage(e[0].id,{action:"highlightText",text:o,options:{type:"word",enabled:!0}})}))}else chrome.tabs.query({active:!0,currentWindow:!0},(e=>{e[0]?.id&&chrome.tabs.sendMessage(e[0].id,{action:"highlightText",text:s,options:{type:"sentence",enabled:!0}})}))}},e.isPlaying=!0,r.play().catch((e=>{console.error("Error playing audio:",e),chrome.runtime.sendMessage({action:"ttsError",error:"Error playing audio: "+e.message})}))}u=e,a={...e,...u},t=new class{constructor(e){this.cache=new Map,this.maxSize=e}get(e){const t=this.cache.get(e);return t?(t.lastAccessed=Date.now(),t.data):null}set(e,t){if(this.cache.size>=this.maxSize){let e="",t=1/0;for(const[s,o]of this.cache.entries())o.lastAccessed<t&&(t=o.lastAccessed,e=s);e&&this.cache.delete(e)}this.cache.set(e,{data:t,lastAccessed:Date.now()})}clear(){this.cache.clear()}}(a.maxCacheSize),s=new class{constructor(){this.metrics={apiCalls:0,cacheHits:0,cacheMisses:0,apiErrors:0,retries:0,avgResponseTime:0,totalResponseTime:0},this.reset()}reset(){this.metrics={apiCalls:0,cacheHits:0,cacheMisses:0,apiErrors:0,retries:0,avgResponseTime:0,totalResponseTime:0}}recordApiCall(e){this.metrics.apiCalls++,this.metrics.totalResponseTime+=e,this.metrics.avgResponseTime=this.metrics.totalResponseTime/this.metrics.apiCalls}recordCacheHit(){this.metrics.cacheHits++}recordCacheMiss(){this.metrics.cacheMisses++}recordApiError(){this.metrics.apiErrors++}recordRetry(){this.metrics.retries++}getMetrics(){return{...this.metrics}}},o=new class{constructor(e){this.batchWindow=e,this.batchQueue=new Map}addRequest(e,t,s){const o=`${t}_${s}`;return new Promise(((a,r)=>{if(this.batchQueue.has(o)){const t=this.batchQueue.get(o);t.texts.push(e);const s=t.resolve;t.resolve=e=>{s(e),a(e)};const i=t.reject;t.reject=e=>{i(e),r(e)}}else{const i=window.setTimeout((()=>{this.processBatch(o)}),this.batchWindow);this.batchQueue.set(o,{texts:[e],voice:t,speed:s,resolve:a,reject:r,timer:i})}}))}processBatch(e){const t=this.batchQueue.get(e);t&&(clearTimeout(t.timer),this.batchQueue.delete(e))}clear(){for(const[e,t]of this.batchQueue.entries())clearTimeout(t.timer),t.reject(new Error("Batch cleared")),this.batchQueue.delete(e)}}(a.batchWindow),chrome.storage.local.get(["performanceConfig"],(e=>{e.performanceConfig&&(a={...a,...e.performanceConfig})})),chrome.storage.local.get(["playbackSettings"],(e=>{e.playbackSettings&&(d={...d,...e.playbackSettings})})),chrome.storage.local.get(["googleApiKey"],(e=>{i=e.googleApiKey?e.googleApiKey:""})),chrome.runtime.onMessage.addListener(((e,t,s)=>{switch(e.action){case"apiKeyUpdated":e.newKey&&(i=e.newKey);break;case"readText":e.text&&e.voice&&void 0!==e.speed&&g(e.text,e.voice,e.speed);break;case"stopReading":n=!1,r&&(r.pause(),r=null),chrome.tabs.query({active:!0,currentWindow:!0},(e=>{e[0]?.id&&chrome.tabs.sendMessage(e[0].id,{action:"clearHighlights"})})),c=[],chrome.runtime.sendMessage({action:"playbackStopped"});break;case"pauseReading":r&&!r.paused&&(r.pause(),chrome.runtime.sendMessage({action:"playbackPaused"}));break;case"resumeReading":r&&r.paused&&(r.play().catch((e=>{console.error("Error resuming audio:",e)})),chrome.runtime.sendMessage({action:"playbackResumed"}));break;case"nextChunk":n&&l<c.length-1&&(r&&r.pause(),l++,p());break;case"previousChunk":n&&l>0&&(r&&r.pause(),l--,p());break;case"jumpToChunk":void 0!==e.chunkIndex&&(o=e.chunkIndex,n&&o>=0&&o<c.length&&(r&&r.pause(),l=o,p()));break;case"updateSettings":e.settings&&(d={...d,...e.settings},r&&e.settings.speed&&(r.playbackRate=e.settings.speed));break;case"getPlaybackState":s({isPlaying:n&&r&&!r.paused,isPaused:n&&r&&r.paused,currentTime:h,totalDuration:0,currentChunk:l,totalChunks:c.length})}var o;return!0})),chrome.runtime.onMessage.addListener(((e,t,s)=>{"updateSpeed"===e.action&&void 0!==e.speed&&(d.speed=e.speed,r&&(r.playbackRate=d.speed),chrome.storage.local.set({playbackSettings:d}),s({success:!0}))})),chrome.contextMenus.create({id:"readSelection",title:"Read Selection with TTS",contexts:["selection"]}),chrome.contextMenus.onClicked.addListener(((e,t)=>{"readSelection"===e.menuItemId&&e.selectionText&&chrome.storage.local.get(["selectedVoice","playbackSettings"],(s=>{const o=s.selectedVoice||"en-US-Neural2-A",a=s.playbackSettings?.speed||1;t?.id&&e.selectionText&&g(e.selectionText,o,a)}))})),chrome.runtime.onMessage.addListener(((e,t,s)=>{if("speakText"===e.action&&e.text)return async function(e,t,s){if(console.log("Preparing to send text to Google TTS API:",e),!i)return void console.error("API key is missing. Please set it in the extension settings.");const o="https://texttospeech.googleapis.com/v1/text:synthesize?key="+i,a={input:{text:e},voice:{languageCode:"en-US",name:t},audioConfig:{audioEncoding:"MP3",speakingRate:s}};try{const e=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!e.ok)throw new Error(`Google TTS API error: ${e.statusText}`);const t=(await e.json()).audioContent;t?new Audio("data:audio/mp3;base64,"+t).play():console.error("No audio content received from Google TTS API.")}catch(e){console.error("Error using Google TTS API:",e)}}(e.text,e.voiceName||"",e.speed||1).then((()=>s({success:!0}))).catch((e=>s({success:!1,error:e.message}))),!0}))})();